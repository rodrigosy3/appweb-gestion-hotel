<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio</title>
    <!-- Cambia 'static' a '/css/' para Thymeleaf -->
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/bootstrap-icons/font/bootstrap-icons.css}">
</head>

<body>
    <div th:insert="~{fragments/navbar :: navbar}"></div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show text-center me-5" role="alert">
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div class="card mx-auto shadow mb-5" style="width: 75%;">
        <div class="card-header text-bg-dark" style="font-size: x-large;">
            <div class="d-flex justify-content-between">
                <div class="fw-bold" th:text="${'Habitación: ' + habitacion.numero}"></div>
                <div class="fw-bold" th:text="${habitacion.tipo.nombre_tipo}"></div>
                <div class="fw-bold" th:text="${'S/. ' + #numbers.formatDecimal(habitacion.precio, 1, 2)}"
                    id="habitacionPrecio" th:data-precio="${habitacion.precio}">PRECIO</div>
            </div>
        </div>

        <div class="card-body">
            <!-- Botones para cambiar contenido -->
            <ul class="nav nav-pills justify-content-between border border-primary rounded mb-4">
                <li class="nav-item">
                    <button class="nav-link fw-bold active" data-bs-toggle="tab" data-bs-target="#venta-tab">SERVICIO DE
                        ALOJAMIENTO</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#reserva-tab">RESERVAR
                        HABITACIÓN</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#estado-tab">ESTADO DE LA
                        HABITACIÓN</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#detalles-tab">CONTENIDO DE
                        LA HABITACIÓN</button>
                </li>
            </ul>

            <!-- Contenido de cada sección -->
            <div class="tab-content mt-3 mx-3">

                <!-- Sección de Clientes -->
                <div th:switch="${habitacion.estado.estado}" class="tab-pane fade show active" id="venta-tab">
                    <!-- Caso: LIMPIEZA -->
                    <div th:case="'LIMPIEZA'">
                        <div class="alert alert-info text-center">
                            <h4 class="fs-2 text-uppercase">Habitación en Limpieza</h4>
                            <p class="fs-4 mt-4">Una vez terminada la limpieza, presiona el botón azul "LIMPIEZA
                                TERMINADA"</p>

                            <form th:action="@{/actualizar-estado-habitacion}" method="post">
                                <input type="hidden" name="id" th:value="${habitacion.id_habitacion}">
                                <input type="hidden" name="nuevoEstado" value="DISPONIBLE">
                                <input type="hidden" name="msgEstado" value="">

                                <div class="col text-center mt-5 mb-3">
                                    <button type="submit" class="btn btn-primary w-25 me-3"
                                        id="btnLimpiezaTerminada">LIMPIEZA
                                        TERMINADA</button>
                                    <button type="button" class="btn btn-danger w-25 ms-3" data-bs-toggle="modal"
                                        data-bs-target="#cancelModal">VOLVER</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Caso: MANTENIMIENTO -->
                    <div th:case="'MANTENIMIENTO'">
                        <div class="alert alert-warning text-center" id="mantenimientoDivPrevio">
                            <h4 class="fs-2 text-uppercase">Habitación en Mantenimiento</h4>
                            <p class="fs-4 mt-4">Esta habitación no está disponible para limpieza ni ventas. <br>
                                Presiona en el botón azul "VER DETALLES" para editar el estado actual de la habitacion.
                            </p>

                            <div class="col text-center mt-5 mb-3">
                                <button type="button" class="btn btn-primary w-25 me-3"
                                    id="btnVerDetallesMantenimiento">VER
                                    DETALLES</button>
                                <button type="button" class="btn btn-danger w-25 ms-3" data-bs-toggle="modal"
                                    data-bs-target="#cancelModal">VOLVER</button>
                            </div>
                        </div>
                    </div>

                    <!-- Caso: NO DISPONIBLE -->
                    <div th:case="'NO DISPONIBLE'">
                        <div class="alert alert-dark text-center" id="noDisponibleDivPrevio">
                            <h4 class="fs-2 text-uppercase">Habitación No Disponible</h4>
                            <p class="fs-4 mt-4">Actualmente esta habitación está fuera de servicio. <br>
                                Presiona en el botón azul "VER DETALLES" para editar el estado actual de la habitacion.
                            </p>

                            <div class="col text-center mt-5 mb-3">
                                <button type="button" class="btn btn-primary w-25 me-3"
                                    id="btnVerDetallesNoDisponible">VER
                                    DETALLES</button>
                                <button type="button" class="btn btn-danger w-25 ms-3" data-bs-toggle="modal"
                                    data-bs-target="#cancelModal">VOLVER</button>
                            </div>
                        </div>
                    </div>

                    <!-- Caso: RESERVA -->
                    <div th:case="'RESERVADA'">
                        <div class="alert alert-success text-center" id="reservadaDivPrevio">
                            <h4 class="fs-2 text-uppercase">Habitación Reservada</h4>
                            <p class="fs-4 mt-5">
                                Presiona en el botón azul "VER DETALLES" para editar la Reserva. <br>
                                Presiona en el botón verde "OCUPAR HABITACIÓN" para finalizar la reserva y generar la
                                venta.
                            </p>

                            <form th:action="@{/actualizar-estado-habitacion}" method="post">
                                <input type="hidden" name="id" th:value="${habitacion.id_habitacion}">
                                <input type="hidden" name="nuevoEstado" value="OCUPADO">
                                <input type="hidden" name="msgEstado" value="">
                                <input type="hidden" name="id_ventaHabitacion" th:value="${ventaParaReserva.id_venta}">

                                <div class="col text-center mt-5 mb-3">
                                    <button type="button" class="btn btn-primary w-25" id="btnVerDetallesReserva">VER
                                        DETALLES
                                    </button>
                                    <button type="submit" class="btn btn-success w-25 mx-3"
                                        id="reservabtnHabilitarReserva">OCUPAR HABITACIÓN</button>
                                    <button type="button" class="btn btn-danger w-25" data-bs-toggle="modal"
                                        data-bs-target="#cancelModal">VOLVER</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div th:case="*" class="tab-pane fade show active" id="venta-tab">
                        <form th:action="@{/{id}(id=${habitacion.id_habitacion})}" th:object="${ventaHabitacion}"
                            id="formVentaHabitacion" method="post">
                            <div class="row row-cols-2 justify-content-between w-100">
                                <div class="col">
                                    <table class="table table-sm table-hover border shadow" id="tablaClientes">
                                        <thead class="table-secondary border-light">
                                            <tr>
                                                <th>D.N.I.</th>
                                                <th>Nombres</th>
                                                <th colspan="2">Apellidos</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tablaClientesBody">
                                            <tr
                                                th:each="cliente : ${ultimaVentaPorHabitacion[habitacion.id_habitacion]?.ventasClientesHabitacion}">
                                                <td class="border align-middle"><span
                                                        th:text="${cliente.usuario_alojado.dni}"></span></td>
                                                <td class="align-middle"><span
                                                        th:text="${cliente.usuario_alojado.nombres}"></span>
                                                </td>
                                                <td class="align-middle"><span
                                                        th:text="${cliente.usuario_alojado.apellidos}"></span></td>
                                                <td class="text-center align-middle border">
                                                    <button type="button" class="btn btn-danger btn-sm"
                                                        th:attr="onclick='eliminarCliente(this, ' + ${cliente.usuario_alojado.dni} + ')'">X</button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="col-5 ms-5">
                                    <div class="row row-cols-3 mb-2">
                                        <div
                                            class="col-2 w-25 align-content-center bg-primary-subtle fw-bold rounded-2">
                                            <label class="col-form-label">D.N.I. <span class="end-0">:</span></label>
                                        </div>
                                        <div class="col-8 w-50">
                                            <input type="text" id="inputDNI" class="form-control" maxlength="8">
                                        </div>
                                        <div class="col-auto w-25 p-0">
                                            <button type="button" class="btn btn-secondary h-100 w-100"
                                                id="btnBuscarDNI">
                                                BUSCAR
                                            </button>
                                        </div>
                                    </div>
                                    <div class="row row-cols-2 mb-2">
                                        <div
                                            class="col-2 w-25 align-content-center bg-primary-subtle fw-bold rounded-2">
                                            <label class="col-form-label">NOMBRES <span class="end-0">:</span></label>
                                        </div>
                                        <div class="col-9 w-75 pe-0">
                                            <input type="text" id="inputNombres" class="form-control text-uppercase">
                                        </div>
                                    </div>
                                    <div class="row row-cols-2 mb-2">
                                        <div
                                            class="col-2 w-25 align-content-center bg-primary-subtle fw-bold rounded-2">
                                            <label class="col-form-label">APELLIDOS <span class="end-0">:</span></label>
                                        </div>
                                        <div class="col-9 w-75 pe-0">
                                            <input type="text" id="inputApellidos" class="form-control text-uppercase">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-auto w-100 mt-2 text-center">
                                            <button type="button" class="btn btn-success w-50 text-uppercase border"
                                                id="btnAgregarCliente">Agregar
                                                Cliente</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <hr class="border border-black my-4">

                            <div class="row row-cols-2 justify-content-between w-100">
                                <div class="col" style="height: min-content;">
                                    <div class="row">
                                        <div class="row row-cols-1">
                                            <table class="table table-hover shadow w-auto">
                                                <thead class="table-secondary border-light">
                                                    <tr>
                                                        <th><label class="form-label">Contenido</label></th>
                                                        <th><label class="form-label">Valor</label></th>
                                                        <th><label class="form-label">Estado</label></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr th:each="contenido : ${habitacion.HabitacionesContenido}">
                                                        <td><span th:text="${contenido.caracteristica.nombre}"></span>
                                                        </td>
                                                        <td><span th:text="${contenido.caracteristica.precio}"></span>
                                                        </td>
                                                        <td><span th:text="${contenido.estado_caracteristica}"></span>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>

                                        <div class="row mt-3">
                                            <div class="col col-auto p-0">
                                                <table class="table table-hover shadow border border-light">
                                                    <thead class="table-secondary mb-2">
                                                        <tr>
                                                            <th class="text-center">DÍA/HORA ENTRADA</th>
                                                            <th class="text-center">SERVICIO</th>
                                                            <th class="text-center">DÍA/HORA SALIDA</th>
                                                            <th class="text-center">PRECIO</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="tableBodyFechasAlojamiento">
                                                        <tr>
                                                            <td><input type="text" id="fechaHoraEntrada"
                                                                    class="form-control">
                                                            </td>
                                                            <td>
                                                            </td>
                                                            <td><input type="text" id="fechaHoraSalida"
                                                                    class="form-control">
                                                            </td>
                                                            <td><input type="text" id="precioHabitacion"
                                                                    class="form-control"></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col mb-3">
                                    <div class="row m-2 shadow rounded-4 align-items-center justify-content-center">
                                        <div class="row mb-3 bg-primary text-light fs-5 fw-bold align-content-center justify-content-center rounded-top-4"
                                            style="height: 2.2rem;">RESUMEN DE LA VENTA</div>

                                        <div class="row row-cols-2 mb-2">
                                            <div class="col align-content-center bg-primary-subtle fw-bold rounded-2">
                                                DÍAS
                                                DE ALOJAMIENTO: </div>
                                            <div class="col">
                                                <input type="number" class="text-center form-control"
                                                    th:field="*{tiempo_estadia}" id="tiempoEstadiaResumen" min="1">
                                            </div>
                                        </div>
                                        <div class="row row-cols-2 mb-4">
                                            <div class="col align-content-center bg-primary-subtle fw-bold rounded-2">
                                                TIPO
                                                DE SERVICIO:</div>
                                            <div class="col">
                                                <select class="form-select text-center" th:field="*{tipo_servicio}"
                                                    id="selectTipoServicioResumen">
                                                    <option th:value="${'COMPLETO'}" data-tipo="COMPLETO">
                                                        COMPLETO
                                                        (12:00 pm)</option>
                                                    <option th:value="${'MEDIO'}" data-tipo="MEDIO">MEDIO DÍA
                                                        (6:00 pm)
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row row-cols-2 mb-2">
                                            <div class="col align-content-center bg-primary-subtle fw-bold rounded-2">
                                                FECHA
                                                DE ENTRADA: </div>
                                            <div class="col">
                                                <input type="text" class="text-center form-control bg-secondary-subtle"
                                                    th:field="*{fecha_entrada}" id="fechaEntradaResumen" readonly>
                                            </div>
                                        </div>
                                        <div class="row row-cols-2 mb-4">
                                            <div class="col align-content-center bg-primary-subtle fw-bold rounded-2">
                                                FECHA
                                                DE SALIDA: </div>
                                            <div class="col">
                                                <input type="text" class="text-center form-control bg-secondary-subtle"
                                                    th:field="*{fecha_salida}" id="fechaSalidaResumen" readonly>
                                            </div>
                                        </div>

                                        <div class="row row-cols-2 mb-2">
                                            <div class="col align-content-center bg-primary-subtle fw-bold rounded-2">
                                                DESCUENTO: </div>
                                            <div class="col">
                                                <input type="number" class="text-center form-control" placeholder="0.00"
                                                    th:field="*{descuento}" id="descuentoResumen" min="0" step="0.01">
                                            </div>
                                        </div>
                                        <div class="row row-cols-2 mb-2">
                                            <div class="col align-content-center bg-primary-subtle fw-bold rounded-2">
                                                ADELANTO DEL TOTAL: </div>
                                            <div class="col">
                                                <input type="number" class="text-center form-control" placeholder="0.00"
                                                    th:field="*{monto_adelanto}" id="montoAdelantoResumen" min="0"
                                                    step="0.01">
                                            </div>
                                        </div>
                                        <div class="row row-cols-2 mb-4">
                                            <div class="col align-content-center bg-primary-subtle fw-bold rounded-2">
                                                TOTAL:
                                            </div>
                                            <div class="col">
                                                <input type="number"
                                                    class="text-center form-control bg-success-subtle fw-bold rounded-2"
                                                    th:field="*{monto_total}" id="montoTotalResumen" min="0" step="0.01"
                                                    readonly>
                                            </div>
                                        </div>
                                        <div class="row row-cols-2 mb-4">
                                            <div class="col align-content-center bg-primary-subtle fw-bold rounded-2">
                                                ESTADO
                                                DE LA VENTA:</div>
                                            <div class="col">
                                                <select class="form-select text-center" th:field="*{estado}"
                                                    id="selectEstadoResumen">
                                                    <option th:value="${'PAGADO'}" data-tipo="PAGADO" selected> PAGADO
                                                    </option>
                                                    <option th:value="${'POR COBRAR'}" data-tipo="POR COBRAR">POR COBRAR
                                                    </option>
                                                </select>
                                            </div>
                                        </div>

                                        <input type="hidden" th:field="*{estado_estadia}" id="estadoEstadia">
                                        <input type="hidden" th:field="*{tipo_venta}" id="tipoVenta"
                                            th:value="${ALQUILER}">
                                        <input type="hidden" th:field="*{id_venta}" id="idVenta">

                                        <div class="row mb-4">
                                            <div class="col text-center">
                                                <button type="button" class="btn btn-primary w-50"
                                                    id="btnGuardar">GUARDAR
                                                    VENTA</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <div class="row my-3">
                            <div class="col text-center">
                                <button type="button" class="btn btn-secondary w-50" id="btnRetirarCliente">
                                    RETIRAR CLIENTE
                                </button>
                            </div>
                            <div class="col text-center">
                                <button type="button" class="btn btn-danger w-50" data-bs-toggle="modal"
                                    data-bs-target="#cancelModal">CANCELAR Y VOLVER</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección de Reservas -->
                <div th:switch="${habitacion.estado.estado}" class="tab-pane fade" id="reserva-tab">
                    <!-- Caso: LIMPIEZA -->
                    <div th:case="'LIMPIEZA'">
                        <div class="alert alert-info text-center">
                            <h4 class="fs-2 text-uppercase">Habitación en Limpieza</h4>
                            <p class="fs-4 mt-4">Una vez terminada la limpieza, presiona el botón azul "LIMPIEZA
                                TERMINADA"</p>

                            <form th:action="@{/actualizar-estado-habitacion}" method="post">
                                <input type="hidden" name="id" th:value="${habitacion.id_habitacion}">
                                <input type="hidden" name="nuevoEstado" value="DISPONIBLE">
                                <input type="hidden" name="msgEstado" value="">

                                <div class="col text-center mt-5 mb-3">
                                    <button type="submit" class="btn btn-primary w-25 me-3"
                                        id="btnLimpiezaTerminada">LIMPIEZA
                                        TERMINADA</button>
                                    <button type="button" class="btn btn-danger w-25 ms-3" data-bs-toggle="modal"
                                        data-bs-target="#cancelModal">VOLVER</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Caso: MANTENIMIENTO -->
                    <div th:case="'MANTENIMIENTO'">
                        <div class="alert alert-warning text-center" id="mantenimientoDivPrevio">
                            <h4 class="fs-2 text-uppercase">Habitación en Mantenimiento</h4>
                            <p class="fs-4 mt-4">Esta habitación no está disponible para limpieza ni ventas. <br>
                                Presiona en el botón azul "VER DETALLES" para editar el estado actual de la habitacion.
                            </p>

                            <div class="col text-center mt-5 mb-3">
                                <button type="button" class="btn btn-primary w-25 me-3"
                                    id="btnVerDetallesMantenimiento">VER
                                    DETALLES</button>
                                <button type="button" class="btn btn-danger w-25 ms-3" data-bs-toggle="modal"
                                    data-bs-target="#cancelModal">VOLVER</button>
                            </div>
                        </div>
                    </div>

                    <!-- Caso: NO DISPONIBLE -->
                    <div th:case="'NO DISPONIBLE'">
                        <div class="alert alert-dark text-center" id="noDisponibleDivPrevio">
                            <h4 class="fs-2 text-uppercase">Habitación No Disponible</h4>
                            <p class="fs-4 mt-4">Actualmente esta habitación está fuera de servicio. <br>
                                Presiona en el botón azul "VER DETALLES" para editar el estado actual de la habitacion.
                            </p>

                            <div class="col text-center mt-5 mb-3">
                                <button type="button" class="btn btn-primary w-25 me-3"
                                    id="btnVerDetallesNoDisponible">VER
                                    DETALLES</button>
                                <button type="button" class="btn btn-danger w-25 ms-3" data-bs-toggle="modal"
                                    data-bs-target="#cancelModal">VOLVER</button>
                            </div>
                        </div>
                    </div>

                    <div th:case="*" class="tab-pane fade show active" id="venta-tab">
                        <form th:action="@{/reservar-habitacion/{id}(id=${habitacion.id_habitacion})}"
                            th:object="${ventaParaReserva}" id="reservaformVentaHabitacion" method="post">
                            <div class="row row-cols-2 justify-content-between w-100">
                                <div class="col">
                                    <table class="table table-sm table-hover border shadow" id="reservatablaClientes">
                                        <thead class="table-secondary border-light">
                                            <tr>
                                                <th>D.N.I.</th>
                                                <th>Nombres</th>
                                                <th colspan="2">Apellidos</th>
                                            </tr>
                                        </thead>
                                        <tbody id="reservatablaClientesBody">
                                            <tr
                                                th:each="cliente : ${ultimaVentaReservadaPorHabitacion[habitacion.id_habitacion]?.ventasClientesHabitacion}">
                                                <td class="border align-middle"><span
                                                        th:text="${cliente.usuario_alojado.dni}"></span></td>
                                                <td class="align-middle"><span
                                                        th:text="${cliente.usuario_alojado.nombres}"></span>
                                                </td>
                                                <td class="align-middle"><span
                                                        th:text="${cliente.usuario_alojado.apellidos}"></span></td>
                                                <td class="text-center align-middle border">
                                                    <button type="button" class="btn btn-danger btn-sm"
                                                        th:attr="onclick='eliminarCliente(this, ' + ${cliente.usuario_alojado.dni} + ')'">X</button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="col-5 ms-5">
                                    <div class="row row-cols-3 mb-2">
                                        <div
                                            class="col-2 w-25 align-content-center bg-primary-subtle fw-bold rounded-2">
                                            <label class="col-form-label">D.N.I. <span class="end-0">:</span></label>
                                        </div>
                                        <div class="col-8 w-50">
                                            <input type="text" id="reservainputDNI" class="form-control" maxlength="8">
                                        </div>
                                        <div class="col-auto w-25 p-0">
                                            <button type="button" class="btn btn-secondary h-100 w-100"
                                                id="reservabtnBuscarDNI">
                                                BUSCAR
                                            </button>
                                        </div>
                                    </div>
                                    <div class="row row-cols-2 mb-2">
                                        <div
                                            class="col-2 w-25 align-content-center bg-primary-subtle fw-bold rounded-2">
                                            <label class="col-form-label">NOMBRES <span class="end-0">:</span></label>
                                        </div>
                                        <div class="col-9 w-75 pe-0">
                                            <input type="text" id="reservainputNombres"
                                                class="form-control text-uppercase">
                                        </div>
                                    </div>
                                    <div class="row row-cols-2 mb-2">
                                        <div
                                            class="col-2 w-25 align-content-center bg-primary-subtle fw-bold rounded-2">
                                            <label class="col-form-label">APELLIDOS <span class="end-0">:</span></label>
                                        </div>
                                        <div class="col-9 w-75 pe-0">
                                            <input type="text" id="reservainputApellidos"
                                                class="form-control text-uppercase">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-auto w-100 mt-2 text-center">
                                            <button type="button" class="btn btn-success w-50 text-uppercase border"
                                                id="reservabtnAgregarCliente">Agregar
                                                Cliente</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <hr class="border border-black my-4">

                            <div class="row row-cols-2 justify-content-between w-100">
                                <div class="col" style="height: min-content;">
                                    <div class="row">
                                        <div class="row row-cols-1">
                                            <table class="table table-hover shadow w-auto">
                                                <thead class="table-secondary border-light">
                                                    <tr>
                                                        <th><label class="form-label">Contenido</label></th>
                                                        <th><label class="form-label">Valor</label></th>
                                                        <th><label class="form-label">Estado</label></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr th:each="contenido : ${habitacion.HabitacionesContenido}">
                                                        <td><span th:text="${contenido.caracteristica.nombre}"></span>
                                                        </td>
                                                        <td><span th:text="${contenido.caracteristica.precio}"></span>
                                                        </td>
                                                        <td><span th:text="${contenido.estado_caracteristica}"></span>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>

                                        <div class="row mt-3">
                                            <div class="col col-auto p-0">
                                                <table class="table table-hover shadow border border-light">
                                                    <thead class="table-secondary mb-2">
                                                        <tr>
                                                            <th class="text-center">DÍA/HORA ENTRADA</th>
                                                            <th class="text-center">SERVICIO</th>
                                                            <th class="text-center">DÍA/HORA SALIDA</th>
                                                            <th class="text-center">PRECIO</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="reservatableBodyFechasAlojamiento">
                                                        <tr>
                                                            <td><input type="text" id="reservafechaHoraEntrada"
                                                                    class="form-control">
                                                            </td>
                                                            <td>
                                                            </td>
                                                            <td><input type="text" id="reservafechaHoraSalida"
                                                                    class="form-control">
                                                            </td>
                                                            <td><input type="text" id="reservaprecioHabitacion"
                                                                    class="form-control"></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col mb-3">
                                    <div class="row m-2 shadow rounded-4 align-items-center justify-content-center">
                                        <div class="row mb-3 bg-primary text-light fs-5 fw-bold align-content-center justify-content-center rounded-top-4"
                                            style="height: 2.2rem;">RESUMEN DE LA RESERVA</div>

                                        <div class="row row-cols-2 mb-4">
                                            <div class="col align-content-center bg-primary-subtle fw-bold rounded-2">
                                                FECHA
                                                DE ENTRADA: </div>
                                            <div class="col">
                                                <input type="datetime-local" class="text-center form-control"
                                                    th:field="*{fecha_entrada}" id="reservafechaEntradaResumen">
                                            </div>
                                        </div>

                                        <div class="row row-cols-2 mb-2">
                                            <div class="col align-content-center bg-primary-subtle fw-bold rounded-2">
                                                DÍAS
                                                DE ALOJAMIENTO: </div>
                                            <div class="col">
                                                <input type="number" class="text-center form-control"
                                                    th:field="*{tiempo_estadia}" id="reservatiempoEstadiaResumen"
                                                    min="1">
                                            </div>
                                        </div>
                                        <div class="row row-cols-2 mb-2">
                                            <div class="col align-content-center bg-primary-subtle fw-bold rounded-2">
                                                TIPO
                                                DE SERVICIO:</div>
                                            <div class="col">
                                                <select class="form-select text-center" th:field="*{tipo_servicio}"
                                                    id="reservaselectTipoServicioResumen">
                                                    <option th:value="${'COMPLETO'}" data-tipo="COMPLETO">
                                                        COMPLETO
                                                        (12:00 pm)</option>
                                                    <option th:value="${'MEDIO'}" data-tipo="MEDIO">MEDIO DÍA
                                                        (6:00 pm)
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row row-cols-2 mb-4">
                                            <div class="col align-content-center bg-primary-subtle fw-bold rounded-2">
                                                FECHA
                                                DE SALIDA: </div>
                                            <div class="col">
                                                <input type="text" class="text-center form-control bg-secondary-subtle"
                                                    th:field="*{fecha_salida}" id="reservafechaSalidaResumen" readonly>
                                            </div>
                                        </div>

                                        <div class="row row-cols-2 mb-2">
                                            <div class="col align-content-center bg-primary-subtle fw-bold rounded-2">
                                                DESCUENTO: </div>
                                            <div class="col">
                                                <input type="number" class="text-center form-control" placeholder="0.00"
                                                    th:field="*{descuento}" id="reservadescuentoResumen" min="0"
                                                    step="0.01">
                                            </div>
                                        </div>
                                        <div class="row row-cols-2 mb-2">
                                            <div class="col align-content-center bg-primary-subtle fw-bold rounded-2">
                                                ADELANTO DEL TOTAL: </div>
                                            <div class="col">
                                                <input type="number" class="text-center form-control" placeholder="0.00"
                                                    th:field="*{monto_adelanto}" id="reservamontoAdelantoResumen"
                                                    min="0" step="0.01">
                                            </div>
                                        </div>
                                        <div class="row row-cols-2 mb-4">
                                            <div class="col align-content-center bg-primary-subtle fw-bold rounded-2">
                                                TOTAL:
                                            </div>
                                            <div class="col">
                                                <input type="number"
                                                    class="text-center form-control bg-success-subtle fw-bold rounded-2"
                                                    th:field="*{monto_total}" id="reservamontoTotalResumen" min="0"
                                                    step="0.01" readonly>
                                            </div>
                                        </div>
                                        <div class="row row-cols-2 mb-4">
                                            <div class="col align-content-center bg-primary-subtle fw-bold rounded-2">
                                                ESTADO
                                                DE LA VENTA:</div>
                                            <div class="col">
                                                <select class="form-select text-center" th:field="*{estado}"
                                                    id="reservaselectEstadoResumen">
                                                    <option th:value="${'PAGADO'}" data-tipo="PAGADO" selected> PAGADO
                                                    </option>
                                                    <option th:value="${'POR COBRAR'}" data-tipo="POR COBRAR">POR COBRAR
                                                    </option>
                                                </select>
                                            </div>
                                        </div>

                                        <input type="hidden" th:field="*{estado_estadia}" id="reservaestadoEstadia">
                                        <input type="hidden" th:field="*{tipo_venta}" id="reservatipoVenta"
                                            th:value="${RESERVA}">
                                        <input type="hidden" th:field="*{id_venta}" id="reservaidVenta">

                                        <div class="row mb-4">
                                            <div class="col text-center">
                                                <button type="button" class="btn btn-primary w-50"
                                                    id="reservabtnGuardar">GUARDAR
                                                    VENTA</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <div class="row alert alert-dark">                            
                            <div class="col text-start w-25">
                                <button type="button" class="btn btn-danger" id="reservabtnRetirarReserva">
                                    CANCELAR Y ELIMINAR RESERVA
                                </button>
                            </div>
                            <div class="col text-start w-25">
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal"
                                    data-bs-target="#cancelModal">VOLVER AL INICIO</button>
                            </div>
                            <div class="col text-center w-50">
                                <button type="button" class="btn btn-success" id="reservabtnHabilitarReserva">
                                    OCUPAR HABITACION Y FINALIZAR RESERVA
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección de estado de habitación -->
                <div th:switch="${habitacion.estado.estado}" class="tab-pane fade" id="estado-tab">
                    <div th:case="'MANTENIMIENTO'">
                        <div class="alert alert-warning">
                            <h4 class="fs-2 text-uppercase text-center mb-3">Habitación en Mantenimiento</h4>

                            <form th:action="@{/editar-estado/habitacion/{id}(id=${habitacion.id_habitacion})}"
                                th:object="${habitacion}" method="post" class="w-50 mx-auto">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Estado de la Habitación:</label>
                                    <select class="form-select" th:field="*{estado}" th>
                                        <option class="text-center" th:each="estado : ${habEstados}"
                                            th:if="${estado.estado != 'OCUPADO' && estado.estado != 'RESERVADA'}"
                                            th:value="${estado.id_habitacion_estado}" th:text="${estado.estado}">ESTADO
                                        </option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Razón:</label>
                                    <textarea class="form-control" th:field="*{razon_estado}" rows="3"
                                        placeholder="Especifica la razón"></textarea>
                                </div>

                                <div class="d-flex justify-content-center">
                                    <button type="button" class="btn btn-danger w-25 me-3" data-bs-toggle="modal"
                                        data-bs-target="#cancelModal">VOLVER</button>

                                    <button type="submit" class="btn btn-primary ms-3">GUARDAR ESTADO EDITADO DE LA
                                        HABITACION</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Caso: NO DISPONIBLE -->
                    <div th:case="'NO DISPONIBLE'">
                        <div class="alert alert-dark">
                            <h4 class="fs-2 text-uppercase text-center mb-3">Habitación no disponible</h4>

                            <form th:action="@{/editar-estado/habitacion/{id}(id=${habitacion.id_habitacion})}"
                                th:object="${habitacion}" method="post" class="w-50 mx-auto">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Estado de la Habitación:</label>
                                    <select class="form-select" th:field="*{estado}" th>
                                        <option class="text-center" th:each="estado : ${habEstados}"
                                            th:if="${estado.estado != 'OCUPADO' && estado.estado != 'RESERVADA'}"
                                            th:value="${estado.id_habitacion_estado}" th:text="${estado.estado}">ESTADO
                                        </option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Razón:</label>
                                    <textarea class="form-control" th:field="*{razon_estado}" rows="3"
                                        placeholder="Especifica la razón"></textarea>
                                </div>

                                <div class="d-flex justify-content-center">
                                    <button type="button" class="btn btn-danger w-25 me-3" data-bs-toggle="modal"
                                        data-bs-target="#cancelModal">VOLVER</button>

                                    <button type="submit" class="btn btn-primary ms-3">GUARDAR ESTADO EDITADO DE LA
                                        HABITACION</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Caso: LIMPIEZA -->
                    <div th:case="'LIMPIEZA'">
                        <div class="alert alert-info text-center">
                            <h4 class="fs-2 text-uppercase">Habitación en Limpieza</h4>
                            <p class="fs-4 mt-4">Una vez terminada la limpieza, presiona el botón azul "LIMPIEZA
                                TERMINADA"</p>

                            <form th:action="@{/actualizar-estado-habitacion}" method="post">
                                <input type="hidden" name="id" th:value="${habitacion.id_habitacion}">
                                <input type="hidden" name="nuevoEstado" value="DISPONIBLE">
                                <input type="hidden" name="msgEstado" value="">

                                <div class="col text-center mt-5 mb-3">
                                    <button type="submit" class="btn btn-primary w-25 me-3"
                                        id="btnLimpiezaTerminada">LIMPIEZA
                                        TERMINADA</button>
                                    <button type="button" class="btn btn-danger w-25 ms-3" data-bs-toggle="modal"
                                        data-bs-target="#cancelModal">VOLVER</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Caso: OCUPADO -->
                    <div th:case="'OCUPADO'">
                        <div class="alert alert-info text-center" id="mantenimientoDivPrevio">
                            <h4 class="fs-2 text-uppercase">Habitación ocupada</h4>
                            <p class="fs-4 mt-4">Esta habitación ha sido alquilada. <br>
                                Presiona en el botón azul "VER DETALLES" para editar el alquiler actual de la
                                habitacion.
                            </p>

                            <div class="col text-center mt-5 mb-3">
                                <button type="button" class="btn btn-primary w-25 me-3" id="btnVerDetallesOcupado">VER
                                    DETALLES</button>
                                <button type="button" class="btn btn-danger w-25 ms-3" data-bs-toggle="modal"
                                    data-bs-target="#cancelModal">VOLVER</button>
                            </div>
                        </div>
                    </div>

                    <!-- Caso: RESERVA -->
                    <div th:case="'RESERVADA'">
                        <div class="alert alert-success text-center" id="reservadaDivPrevio">
                            <h4 class="fs-2 text-uppercase">Habitación Reservada</h4>
                            <p class="fs-4 mt-5">
                                Presiona en el botón azul "VER DETALLES" para editar la Reserva. <br>
                                Presiona en el botón verde "OCUPAR HABITACIÓN" para finalizar la reserva y generar la
                                venta.
                            </p>

                            <form th:action="@{/actualizar-estado-habitacion}" method="post">
                                <input type="hidden" name="id" th:value="${habitacion.id_habitacion}">
                                <input type="hidden" name="nuevoEstado" value="OCUPADO">
                                <input type="hidden" name="msgEstado" value="">
                                <input type="hidden" name="id_ventaHabitacion" th:value="${ventaParaReserva.id_venta}">

                                <div class="col text-center mt-5 mb-3">
                                    <button type="button" class="btn btn-primary w-25" id="btnVerDetallesReserva">VER
                                        DETALLES
                                    </button>
                                    <button type="submit" class="btn btn-success w-25 mx-3"
                                        id="reservabtnHabilitarReserva">OCUPAR HABITACIÓN</button>
                                    <button type="button" class="btn btn-danger w-25" data-bs-toggle="modal"
                                        data-bs-target="#cancelModal">VOLVER</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Caso por defecto: Formulario para agregar un nuevo estado -->
                    <div th:case="*">
                        <div class="alert shadow w-50 mx-auto">
                            <h4 class="fs-2 text-uppercase text-center mb-3">Habitación disponible</h4>

                            <form th:action="@{/editar-estado/habitacion/{id}(id=${habitacion.id_habitacion})}"
                                th:object="${habitacion}" method="post" class="mx-auto">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Estado de la Habitación:</label>
                                    <select class="form-select" th:field="*{estado}" th>
                                        <option class="text-center" th:each="estado : ${habEstados}"
                                            th:if="${estado.estado != 'OCUPADO' && estado.estado != 'RESERVADA'}"
                                            th:value="${estado.id_habitacion_estado}" th:text="${estado.estado}">ESTADO
                                        </option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Razón:</label>
                                    <textarea class="form-control" th:field="*{razon_estado}" rows="3"
                                        placeholder="Especifica la razón"></textarea>
                                </div>

                                <div class="d-flex justify-content-center">
                                    <button type="button" class="btn btn-danger w-25 me-3" data-bs-toggle="modal"
                                        data-bs-target="#cancelModal">VOLVER</button>

                                    <button type="submit" class="btn btn-primary ms-3">GUARDAR ESTADO EDITADO DE LA
                                        HABITACION</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Sección de Detalles -->
                <div class="tab-pane fade" id="detalles-tab">
                    <h4 class="text-center fw-bold mt-3">Detalles de la Habitación</h4>

                    <div class="table-responsive">
                        <table class="table table-hover shadow-sm border">
                            <thead class="table-dark">
                                <tr>
                                    <th>Característica</th>
                                    <th>Descripción</th>
                                    <th class="text-center">Precio</th>
                                    <th class="text-center">Estado</th>
                                    <th class="text-center">Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="contenido : ${habitacion.habitacionesContenido}">
                                    <td class="align-middle">
                                        <span th:text="${contenido.caracteristica.nombre}"></span>
                                    </td>
                                    <td class="align-middle">
                                        <span th:text="${contenido.caracteristica.descripcion}"></span>
                                    </td>
                                    <td class="align-middle text-center">
                                        <span th:text="'S/. ' + ${contenido.caracteristica.precio}"></span>
                                    </td>
                                    <td class="align-middle text-center">
                                        <select class="form-select text-center estado-selector"
                                            th:id="'estado_' + ${contenido.id_habitacion_contenido}"
                                            th:data-id="${contenido.id_habitacion_contenido}">
                                            <option class="text-uppercase" value="DISPONIBLE"
                                                th:selected="${contenido.estado_caracteristica == 'DISPONIBLE'}">
                                                DISPONIBLE</option>
                                            <option class="text-uppercase" value="EN MANTENIMIENTO"
                                                th:selected="${contenido.estado_caracteristica == 'EN MANTENIMIENTO'}">
                                                EN MANTENIMIENTO</option>
                                            <option class="text-uppercase" value="MALOGRADO"
                                                th:selected="${contenido.estado_caracteristica == 'MALOGRADO'}">
                                                MALOGRADO</option>
                                        </select>
                                    </td>
                                    <td class="align-middle text-center">
                                        <button class="btn btn-success guardar-btn"
                                            th:id="'guardar_' + ${contenido.id_habitacion_contenido}"
                                            disabled>GUARDAR</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="text-center">
                            <button type="button" class="btn btn-danger w-25 mt-5 mb-2" data-bs-toggle="modal"
                                        data-bs-target="#cancelModal">VOLVER</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <hr>

    <div class="container-fluid py-3">
        <div class="row">
            <!-- Primera tabla: lado izquierdo -->
            <div class="col-12 col-lg-6 justify-content-center" th:if="${!hab_antiguas.isEmpty()}">
                <table class="table table-hover">
                    <thead class="table-secondary border-light">
                        <tr>
                            <th class="text-center">N°</th>
                            <th class="text-center">INGRESO</th>
                            <th>NOMBRES Y APELLIDOS</th>
                            <th class="text-center px-0">EDAD</th>
                            <th class="text-center px-0">D.N.I.</th>
                            <th class="text-center">TOTAL</th>
                            <th class="text-center px-0">ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="hab : ${hab_antiguas}">
                            <td class="text-center fw-bold border-light bg-body-secondary align-middle"
                                th:text="${hab.numero}"
                                th:title="${'(' + hab.tipo.abreviacion_tipo + ') ' +hab.tipo.nombre_tipo}">N°</td>
                            <td class="text-center"
                                th:text="${ultimaVentaPorHabitacionFechaFormateada[hab.id_habitacion] != null ? #temporals.format(ultimaVentaPorHabitacionFechaFormateada[hab.id_habitacion], 'hh:mm a') : ''}">
                                INGRESO
                            </td>
                            <td>
                                <span
                                    th:each="cliente : ${ultimaVentaPorHabitacion[hab.id_habitacion]?.ventasClientesHabitacion}">
                                    <span
                                        th:text="${cliente.usuario_alojado.nombres + ' ' + cliente.usuario_alojado.apellidos}">NOMBRES
                                        Y APELLIDOS</span><br />
                                </span>
                            </td>
                            <td class="text-center">
                                <span
                                    th:each="cliente : ${ultimaVentaPorHabitacion[hab.id_habitacion]?.ventasClientesHabitacion}">
                                    <span th:text="${cliente.usuario_alojado.edad}">EDAD</span><br />
                                </span>
                            </td>
                            <td class="text-center">
                                <span
                                    th:each="cliente : ${ultimaVentaPorHabitacion[hab.id_habitacion]?.ventasClientesHabitacion}">
                                    <span th:text="${cliente.usuario_alojado.dni}">D.N.I.</span><br />
                                </span>
                            </td>
                            <td class="text-center align-middle"
                                th:text="${ultimaVentaPorHabitacionFechaFormateada[hab.id_habitacion] != null ? #numbers.formatDecimal(ultimaVentaPorHabitacion[hab.id_habitacion]?.monto_total, 1, 2) : ''}">
                                TOTAL</td>
                            <td class="text-center align-middle">
                                <a class="btn btn-sm btn-primary" role="button" title="EDITAR"
                                    th:href="@{/editar/{id}(id=${hab.id_habitacion})}">
                                    Editar
                                </a>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Segunda tabla: lado derecho -->
            <div class="col-12 col-lg-6 justify-content-center" th:if="${!hab_modernas.isEmpty()}">
                <table class="table table-hover">
                    <thead class="table-info border-light">
                        <tr>
                            <th class="text-center">N°</th>
                            <th class="text-center">INGRESO</th>
                            <th>NOMBRES Y APELLIDOS</th>
                            <th class="text-center px-0">EDAD</th>
                            <th class="text-center px-0">D.N.I.</th>
                            <th class="text-center">TOTAL</th>
                            <th class="text-center px-0">ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="hab : ${hab_modernas}">
                            <td class="text-center fw-bold border-light bg-info-subtle align-middle"
                                th:text="${hab.numero}"
                                th:title="${'(' + hab.tipo.abreviacion_tipo + ') ' + hab.tipo.nombre_tipo}">N°</td>
                            <td class="text-center"
                                th:text="${ultimaVentaPorHabitacionFechaFormateada[hab.id_habitacion] != null ? #temporals.format(ultimaVentaPorHabitacionFechaFormateada[hab.id_habitacion], 'hh:mm a') : ''}">
                                INGRESO
                            </td>
                            <td>
                                <span
                                    th:each="cliente : ${ultimaVentaPorHabitacion[hab.id_habitacion]?.ventasClientesHabitacion}">
                                    <span
                                        th:text="${cliente.usuario_alojado.nombres + '  ' + cliente.usuario_alojado.apellidos}">NOMBRES
                                        Y APELLIDOS</span><br />
                                </span>
                            </td>
                            <td class="text-center">
                                <span
                                    th:each="cliente : ${ultimaVentaPorHabitacion[hab.id_habitacion]?.ventasClientesHabitacion}">
                                    <span th:text="${cliente.usuario_alojado.edad}">EDAD</span><br />
                                </span>
                            </td>
                            <td class="text-center">
                                <span
                                    th:each="cliente : ${ultimaVentaPorHabitacion[hab.id_habitacion]?.ventasClientesHabitacion}">
                                    <span th:text="${cliente.usuario_alojado.dni}">D.N.I.</span><br />
                                </span>
                            </td>
                            <td class="text-center"
                                th:text="${ultimaVentaPorHabitacionFechaFormateada[hab.id_habitacion] != null && !ultimaVentaPorHabitacion[hab.id_habitacion] ?.estado_estadia.equals('RETIRADO') ? #numbers.formatDecimal(ultimaVentaPorHabitacion[hab.id_habitacion]?.monto_total, 1, 2) : ''}">
                                TOTAL</td>
                            <td class="text-center align-middle">
                                <a class="btn btn-sm btn-primary align-middle" role="button" title="EDITAR"
                                    th:href="@{/editar/{id}(id=${hab.id_habitacion})}">
                                    Editar
                                </a>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- <div th:insert="~{fragments/modal :: modal('/')}"></div> -->

    <div th:insert="~{fragments/modal :: modal('/')}"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const inputDNI = document.getElementById("inputDNI");
            const inputNombres = document.getElementById("inputNombres");
            const inputApellidos = document.getElementById("inputApellidos");
            const tablaClientesBody = document.getElementById("tablaClientesBody");
            const idVentaInput = document.getElementById("idVenta");

            let clientesTemporales = []; // Clientes agregados y a agregar en esta sesión

            // Cargar los clientes ya registrados en la lista temporal
            if (idVentaInput && idVentaInput.value.trim() !== "") {
                document.querySelectorAll("#tablaClientesBody tr").forEach(row => {
                    let dni = row.cells[0].innerText;
                    let nombres = row.cells[1].innerText;
                    let apellidos = row.cells[2].innerText;
                    clientesTemporales.push({ dni, nombres, apellidos, eliminado: false });
                });
            }

            if (idVentaInput) { actualizarEstadoBoton() };
            // Función para agregar un cliente temporalmente
            function agregarCliente() {
                const dni = inputDNI.value.trim();
                const nombres = inputNombres.value.trim().toUpperCase();
                const apellidos = inputApellidos.value.trim().toUpperCase();

                if (!dni || !nombres || !apellidos) {
                    alert("Por favor, completa todos los campos del cliente.");
                    return;
                }

                let clienteExistente = clientesTemporales.find(cliente => cliente.dni === dni);

                if (clienteExistente) {
                    if (clienteExistente.eliminado) {
                        // Si estaba eliminado, lo reactivamos
                        clienteExistente.eliminado = false;
                    } else {
                        alert("Este cliente ya está agregado.");
                        return;
                    }
                } else {
                    // Si el cliente no existe, lo agregamos como nuevo
                    clientesTemporales.push({ dni, nombres, apellidos, eliminado: false });
                }

                const fila = document.createElement("tr");
                fila.innerHTML = `
                    <td class="border align-middle">${dni}</td>
                    <td class="align-middle">${nombres}</td>
                    <td class="align-middle">${apellidos}</td>
                    <td class="text-center align-middle border">
                        <button type="button" class="btn btn-danger btn-sm" onclick="eliminarCliente(this, '${dni}')">X</button>
                    </td>
                `;
                tablaClientesBody.appendChild(fila);

                inputDNI.value = "";
                inputNombres.value = "";
                inputApellidos.value = "";

                if (clientesTemporales.length == 1) { actualizarEstadoBoton(); }
            }

            // Función para eliminar un cliente temporalmente
            window.eliminarCliente = function (button, dni) {
                dni = String(dni);  // Convertir siempre a string
                console.log("Tipo DNI recibido:", typeof dni, dni);

                clientesTemporales.forEach(cliente => {
                    if (cliente.dni === dni) {
                        cliente.eliminado = true;
                    }
                });

                button.closest("tr").remove();
            };

            // Función para buscar cliente en la BD antes de la API externa
            function buscarClienteEnBD() {
                const dni = inputDNI.value.trim();

                if (dni < 8) {
                    alert("El DNI debe contener 8 números.");
                    return;
                }

                fetch(`/buscar-cliente?dni=${dni}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.encontrado) {
                            inputNombres.value = data.nombres;
                            inputApellidos.value = data.apellidos;
                        } else {
                            console.log("Cliente no encontrado en la base de datos. Consultando API externa...");
                            buscarClienteEnAPI(dni);
                        }
                    })
                    .catch(error => console.error("Error buscando cliente:", error));
            }

            function buscarClienteEnAPI(dni) {
                if (dni.length !== 8) {
                    alert("El DNI debe tener 8 dígitos.");
                    return;
                }

                const apiUrl = `http://localhost:3000/api/dni?numero=${dni}`; // Cambia el puerto según la configuración de Spring Boot

                fetch(apiUrl)
                    .then(response => {
                        console.log("Estado de la respuesta:", response.status);
                        if (!response.ok) {
                            throw new Error("Error al consultar el backend.");
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.numeroDocumento) {
                            document.getElementById("inputNombres").value = data.nombres || "";
                            document.getElementById("inputApellidos").value = `${data.apellidoPaterno || ""
                                } ${data.apellidoMaterno || ""}`.trim();
                        } else {
                            alert("No se encontró información para este DNI. Agregar manualmente");
                        }
                    })
                    .catch(error => {
                        console.error("Error al realizar la consulta:", error);
                    });
            }

            function actualizarEstadoBoton() {
                if (clientesTemporales.length > 0) {
                    document.getElementById("btnGuardar").disabled = false;
                } else {
                    document.getElementById("btnGuardar").disabled = true;
                }
            }

            function guardarVenta(event) {
                event.preventDefault(); // Evita el envío normal del formulario

                // Obtener el formulario
                let form = document.getElementById("formVentaHabitacion");

                // Crear objeto FormData con los datos del formulario
                let formData = new FormData(form);

                // Convertir clientesTemporales a JSON y agregarlo al formData
                formData.append("clientesTemporales", JSON.stringify(clientesTemporales));

                // Enviar los datos al backend
                fetch(form.action, {
                    method: "POST",
                    body: formData
                }).then(response => {
                    if (response.ok) {
                        window.location.href = "/"; // Redirigir a la página principal después de guardar
                    } else {
                        console.log("Error al guardar la venta");
                        window.location.href = "/";
                    }
                }).catch(error => console.error("Error:", error));
            };

            function retirarCliente() {
                const idVenta = idVentaInput.value;  // Obtiene el ID de la venta
                const estadoEstadia = "RETIRADO";

                if (!idVenta) {
                    alert("No se puede actualizar el estado sin una venta registrada.");
                    return;
                }

                fetch(`/actualizar-estado/${idVenta}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ estado_estadia: estadoEstadia })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Error al actualizar el estado de la venta");
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Estado actualizado correctamente");
                        //location.reload(); // Recargar la página para ver el cambio reflejado
                        window.location.href = "/";
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        alert("Hubo un problema al actualizar el estado.");
                    });
            };


            // FECHAS
            const fechaSalidaResumen = document.getElementById("fechaSalidaResumen");
            const fechaEntradaResumen = document.getElementById("fechaEntradaResumen");
            const diasAlojamientoResumen = document.getElementById("tiempoEstadiaResumen");

            const selectServicio = document.getElementById("selectTipoServicioResumen");

            const descuentoResumen = document.getElementById("descuentoResumen");
            const montoAdelantoResumen = document.getElementById("montoAdelantoResumen");
            const montoTotalResumen = document.getElementById("montoTotalResumen");

            const precioInput = document.getElementById("habitacionPrecio");
            const tablaFechasBody = document.getElementById("tableBodyFechasAlojamiento");

            let fechaActual = new Date();

            // **(1) La fecha de entrada vacía tomará la del resumen o la actual**
            if (fechaEntradaResumen) {
                if (!fechaEntradaResumen.value) {
                    fechaEntradaResumen.value = fechaParseString(fechaActual);
                }
                // Inicializar
                actualizarFilas();
            }

            // Formatear fecha a 'YYYY-MM-DD hh:mm A'
            function fechaParseString(fecha) {
                const opcionesFecha = { year: 'numeric', month: '2-digit', day: '2-digit' };
                const opcionesHora = { hour: '2-digit', minute: '2-digit', hour12: true };
                const fechaFormateada = fecha.toLocaleDateString('es-ES', opcionesFecha).split('/').reverse().join('-');
                const horaFormateada = fecha.toLocaleTimeString('es-ES', opcionesHora).replace('.', '.');

                return `${fechaFormateada} ${horaFormateada}`;
            }

            function fechaParseStringDiaHora(fecha) {
                const opcionesFecha = { day: '2-digit' };
                const opcionesHora = { hour: '2-digit', minute: '2-digit', hour12: true };
                const fechaFormateada = fecha.toLocaleDateString('es-ES', opcionesFecha);
                const horaFormateada = fecha.toLocaleTimeString('es-ES', opcionesHora).replace('.', '.');

                return `| ${fechaFormateada} | ${horaFormateada}`;
            }

            function stringParseFecha(fechaStr) {
                let [fecha, hora] = fechaStr.split(" ");
                let [year, month, day] = fecha.split("-").map(num => parseInt(num));
                let [hour, minute] = hora.split(":").map(num => parseInt(num));
                let meridiano = hora.includes("AM") ? "AM" : "PM";

                // Ajustar la hora según AM/PM
                if (meridiano === "PM" && hour < 12) {
                    hour += 12;  // Convertir a 24 horas
                } else if (meridiano === "AM" && hour === 12) {
                    hour = 0; // Convertir medianoche a 00:00
                }

                return new Date(year, month - 1, day, hour, minute);
            }


            // **(4) Calcular fecha de salida**
            function calcularFechaSalida(fecha, tipoServicio) {
                let fechaSalida = new Date(fecha);

                if (tipoServicio.includes("COMPLETO")) {
                    fechaSalida.setDate(fechaSalida.getDate() + 1);
                    fechaSalida.setHours(12, 0, 0); // Medio día del día siguiente
                } else {
                    fechaSalida.setHours(18, 0, 0); // 6 PM del mismo día
                }
                return fechaParseString(fechaSalida);
            }

            // **(2) Manejar el cambio de días de alojamiento**
            function actualizarFilas() {
                const dias = parseInt(diasAlojamientoResumen.value) || 1;
                tablaFechasBody.innerHTML = ""; // Limpiar la tabla antes de reconstruirla

                let fechaBase = new Date(stringParseFecha(fechaEntradaResumen.value));

                for (let i = 0; i < dias; i++) {
                    let nuevaFila = document.createElement("tr");
                    let fechaEntradaStr = fechaParseStringDiaHora(fechaBase);
                    let tipo_servicio = selectServicio.options[selectServicio.selectedIndex];
                    let fechaSalidaStr = calcularFechaSalida(new Date(fechaBase), tipo_servicio.getAttribute("data-tipo"));
                    let fechaSalidaStrDiaHora = fechaParseStringDiaHora(stringParseFecha(fechaSalidaStr));

                    nuevaFila.innerHTML = `
                            <td class="align-middle text-center">
                                <span class="bg-success-subtle rounded-4 p-2">${fechaEntradaStr}</span>
                            </td>
                            <td class="align-middle text-center">
                                <span class="bg-secondary-subtle rounded-4 p-2">
                                    ${tipo_servicio.getAttribute("data-tipo").includes("COMPLETO") ? "COMPLETO" : "MEDIO DÍA"}
                                </span>
                            </td>
                            <td class="align-middle text-center"><span class="bg-danger-subtle rounded-4 p-2">${fechaSalidaStrDiaHora}</span></td>
                            <td class="align-middle text-center"><span class="mx-3">${'S/. ' + calcularImporte()}</span></td>
                        `;
                    tablaFechasBody.appendChild(nuevaFila);

                    fechaBase = new Date(stringParseFecha(fechaSalidaStr));
                }

                actualizarResumen();
            }

            // **(3) Calcular importe según tipo de servicio**
            function calcularImporte() {
                let precioBase = parseFloat(precioInput.getAttribute("data-precio")) || 0;
                let tipo_servicio = selectServicio.options[selectServicio.selectedIndex];

                return tipo_servicio.getAttribute("data-tipo").includes("MEDIO") ? (precioBase / 2).toFixed(2) : precioBase.toFixed(2);
            }

            // **(5) Bloquear servicio si hay más de un día**
            function manejarBloqueoServicio() {
                if (parseInt(diasAlojamientoResumen.value) > 1) {
                    selectServicio.value = "COMPLETO";
                    selectServicio.setAttribute("disabled", true);
                } else {
                    selectServicio.removeAttribute("disabled");
                }
                actualizarFilas();
            }

            // **(6) Calcular monto total**
            function calcularMontoTotal() {
                let dias = parseInt(diasAlojamientoResumen.value) || 1;
                let precioBase = calcularImporte(parseFloat(precioInput.getAttribute("data-precio")) || 0);
                let descuento = parseFloat(descuentoResumen.value) || 0;
                let adelanto = parseFloat(montoAdelantoResumen.value) || 0;

                return ((dias * precioBase) - descuento - adelanto).toFixed(2);
            }

            // **(4) Calcular fecha de salida**
            function calcularFechaSalidaParaDias(fecha, dias) {
                let fechaSalida = new Date(fecha);

                fechaSalida.setDate(fechaSalida.getDate() + dias);
                fechaSalida.setHours(12, 0, 0); // Medio día del día siguiente

                return fechaParseString(fechaSalida);
            }

            // **Actualizar el resumen final**
            function actualizarResumen() {
                let fechaEntrada = stringParseFecha(fechaEntradaResumen.value);
                let dias = parseInt(diasAlojamientoResumen.value) || 1;
                let fechaSalida;

                if (dias > 1) {
                    fechaSalida = calcularFechaSalidaParaDias(fechaEntrada, dias);
                } else {
                    fechaSalida = calcularFechaSalida(fechaEntrada, selectServicio.options[selectServicio.selectedIndex].getAttribute("data-tipo"));
                }

                fechaSalidaResumen.value = fechaSalida;
                montoTotalResumen.value = calcularMontoTotal();
            }

            // **Eventos**
            if (fechaEntradaResumen) {
                fechaEntradaResumen.addEventListener("change", actualizarFilas);
            }
            if (diasAlojamientoResumen) {
                diasAlojamientoResumen.addEventListener("input", manejarBloqueoServicio);
            }
            if (selectServicio) {
                selectServicio.addEventListener("change", actualizarFilas);
            }
            if (descuentoResumen) {
                descuentoResumen.addEventListener("input", actualizarResumen);
            }
            if (montoAdelantoResumen) {
                montoAdelantoResumen.addEventListener("input", actualizarResumen);
            }


            function cambiarTabEstado(estado) {
                if (estado === "RESERVADA") {
                    let estadoTab = document.querySelector('[data-bs-target="#reserva-tab"]');
                    if (estadoTab) {
                        new bootstrap.Tab(estadoTab).show();
                    }
                } else if (estado === "OCUPADO") {
                    let estadoTab = document.querySelector('[data-bs-target="#venta-tab"]');
                    if (estadoTab) {
                        new bootstrap.Tab(estadoTab).show();
                    }
                } else {
                    let estadoTab = document.querySelector('[data-bs-target="#estado-tab"]');
                    if (estadoTab) {
                        new bootstrap.Tab(estadoTab).show();
                    }
                }
            }

            document.addEventListener("click", function (event) {
                if (event.target.id === "btnRetirarCliente") {
                    retirarCliente();
                }
                if (event.target.id === "btnAgregarCliente") {
                    agregarCliente();
                }
                if (event.target.id === "btnBuscarDNI") {
                    buscarClienteEnBD();
                }
                if (event.target.id === "btnGuardar") {
                    guardarVenta(event);
                }

                // Cambio de targets
                if (event.target.id === "btnVerDetallesMantenimiento") {
                    cambiarTabEstado("MANTENIMIENTO");
                }
                if (event.target.id === "btnVerDetallesNoDisponible") {
                    cambiarTabEstado("NO DISPONIBLE");
                }
                if (event.target.id === "btnVerDetallesReserva") {
                    cambiarTabEstado("RESERVADA");
                }
                if (event.target.id === "btnVerDetallesOcupado") {
                    cambiarTabEstado("OCUPADO");
                }
                
                if (event.target.id === "reservabtnRetirarReserva") {
                    reservaEliminarReserva();
                }
                if (event.target.id === "reservabtnHabilitarReserva") {
                    reservaCambiarEstadoReserva();
                }
                if (event.target.id === "reservabtnAgregarCliente") {
                    reservaagregarCliente();
                }
                if (event.target.id === "reservabtnBuscarDNI") {
                    reservabuscarClienteEnBD();
                }
                if (event.target.id === "reservabtnGuardar") {
                    reservaguardarReserva(event);
                }
            });

















            const reservainputDNI = document.getElementById("reservainputDNI");
            const reservainputNombres = document.getElementById("reservainputNombres");
            const reservainputApellidos = document.getElementById("reservainputApellidos");
            const reservatablaClientesBody = document.getElementById("reservatablaClientesBody");
            const reservaidVentaInput = document.getElementById("reservaidVenta");

            let reservaclientesTemporales = []; // Clientes agregados y a agregar en esta sesión

            // Cargar los clientes ya registrados en la lista temporal
            if (reservaidVentaInput && reservaidVentaInput.value.trim() !== "") {
                document.querySelectorAll("#tablaClientesBody tr").forEach(row => {
                    let dni = row.cells[0].innerText;
                    let nombres = row.cells[1].innerText;
                    let apellidos = row.cells[2].innerText;
                    reservaclientesTemporales.push({ dni, nombres, apellidos, eliminado: false });
                });
            }
            if (reservaidVentaInput) { reservaactualizarEstadoBoton(); }

            // Función para agregar un cliente temporalmente
            function reservaagregarCliente() {
                const dni = reservainputDNI.value.trim();
                const nombres = reservainputNombres.value.trim().toUpperCase();
                const apellidos = reservainputApellidos.value.trim().toUpperCase();

                if (!dni || !nombres || !apellidos) {
                    alert("Por favor, completa todos los campos del cliente.");
                    return;
                }

                let ClienteExistente = reservaclientesTemporales.find(cliente => cliente.dni === dni);

                if (ClienteExistente) {
                    if (ClienteExistente.eliminado) {
                        // Si estaba eliminado, lo reactivamos
                        ClienteExistente.eliminado = false;
                    } else {
                        alert("Este cliente ya está agregado.");
                        return;
                    }
                } else {
                    // Si el cliente no existe, lo agregamos como nuevo
                    reservaclientesTemporales.push({ dni, nombres, apellidos, eliminado: false });
                }

                const fila = document.createElement("tr");
                fila.innerHTML = `
                    <td class="border align-middle">${dni}</td>
                    <td class="align-middle">${nombres}</td>
                    <td class="align-middle">${apellidos}</td>
                    <td class="text-center align-middle border">
                        <button type="button" class="btn btn-danger btn-sm" onclick="reservaeliminarCliente(this, '${dni}')">X</button>
                    </td>
                `;
                reservatablaClientesBody.appendChild(fila);

                reservainputDNI.value = "";
                reservainputNombres.value = "";
                reservainputApellidos.value = "";

                if (reservaclientesTemporales.length == 1) { reservaactualizarEstadoBoton(); }
            }

            // Función para eliminar un cliente temporalmente
            window.reservaeliminarCliente = function (button, dni) {
                dni = String(dni);  // Convertir siempre a string

                reservaclientesTemporales.forEach(cliente => {
                    if (cliente.dni === dni) {
                        cliente.eliminado = true;
                    }
                });

                button.closest("tr").remove();
            };

            // Función para buscar cliente en la BD antes de la API externa
            function reservabuscarClienteEnBD() {
                const dni = reservainputDNI.value.trim();

                if (dni < 8) {
                    alert("El DNI debe contener 8 números.");
                    return;
                }

                fetch(`/buscar-cliente?dni=${dni}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.encontrado) {
                            reservainputNombres.value = data.nombres;
                            reservainputApellidos.value = data.apellidos;
                        } else {
                            console.log("Cliente no encontrado en la base de datos. Consultando API externa...");
                            reservabuscarClienteEnAPI(dni);
                        }
                    })
                    .catch(error => console.error("Error buscando cliente:", error));
            }

            function reservabuscarClienteEnAPI(dni) {
                if (dni.length !== 8) {
                    alert("El DNI debe tener 8 dígitos.");
                    return;
                }

                const apiUrl = `http://localhost:3000/api/dni?numero=${dni}`; // Cambia el puerto según la configuración de Spring Boot

                fetch(apiUrl)
                    .then(response => {
                        console.log("Estado de la respuesta:", response.status);
                        if (!response.ok) {
                            throw new Error("Error al consultar el backend.");
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.numeroDocumento) {
                            document.getElementById("reservainputNombres").value = data.nombres || "";
                            document.getElementById("reservainputApellidos").value = `${data.apellidoPaterno || ""
                                } ${data.apellidoMaterno || ""}`.trim();
                        } else {
                            alert("No se encontró información para este DNI. Agregar manualmente");
                        }
                    })
                    .catch(error => {
                        console.error("Error al realizar la consulta:", error);
                    });
            }

            function reservaactualizarEstadoBoton() {
                if (reservaclientesTemporales.length > 0) {
                    document.getElementById("reservabtnGuardar").disabled = false;
                } else {
                    document.getElementById("reservabtnGuardar").disabled = true;
                }
            }

            function reservaguardarReserva(event) {
                event.preventDefault(); // Evita el envío normal del formulario

                // Obtener el formulario
                let form = document.getElementById("reservaformVentaHabitacion");

                // Crear objeto FormData con los datos del formulario
                let formData = new FormData(form);

                // Convertir reservaclientesTemporales a JSON y agregarlo al formData
                formData.append("reservaclientesTemporales", JSON.stringify(reservaclientesTemporales));

                // Enviar los datos al backend
                fetch(form.action, {
                    method: "POST",
                    body: formData
                }).then(response => {
                    if (response.ok) {
                        window.location.href = "/"; // Redirigir a la página principal después de guardar
                    } else {
                        alert("Error al guardar la venta");
                    }
                }).catch(error => console.error("Error:", error));
            };

            function reservaEliminarReserva () {
                const idVentaReservada = reservaidVentaInput.value;
                console.log(idVentaReservada);
                if (!idVentaReservada) {
                    console.log("No se puede cancelar una reserva no registrada.");
                    return;
                }

                fetch(`/cancelar-reserva/${idVentaReservada}`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify()
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Error al cancelar la reserva");
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Reserva cancelada correctamente");
                        location.reload(); // Recargar la página para ver el cambio reflejado
                        //window.location.href = "/";
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        alert("Hubo un problema al cancelar la reserva.");
                    });
            }

            function reservaCambiarEstadoReserva() {
                const idVenta = reservaidVentaInput.value;  // Obtiene el ID de la venta

                if (!idVenta) {
                    console.log("No se puede finalizar reserva no registrada.");
                    return;
                }

                fetch(`/habilitar-reserva/${idVenta}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify()
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Error al actualizar el estado de la venta");
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Reserva cancelada correctamente");
                        //location.reload(); // Recargar la página para ver el cambio reflejado
                        window.location.href = "/";
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        alert("Hubo un problema al cancelar la reserva.");
                    });
            };


            // FECHAS
            const reservafechaSalidaResumen = document.getElementById("reservafechaSalidaResumen");
            const reservafechaEntradaResumen = document.getElementById("reservafechaEntradaResumen");
            const reservadiasAlojamientoResumen = document.getElementById("reservatiempoEstadiaResumen");

            const reservaselectServicio = document.getElementById("reservaselectTipoServicioResumen");

            const reservadescuentoResumen = document.getElementById("reservadescuentoResumen");
            const reservamontoAdelantoResumen = document.getElementById("reservamontoAdelantoResumen");
            const reservamontoTotalResumen = document.getElementById("reservamontoTotalResumen");

            const reservaprecioInput = document.getElementById("habitacionPrecio");
            const reservatablaFechasBody = document.getElementById("reservatableBodyFechasAlojamiento");

            let reservafechaActual = new Date();

            function reservaconvertirFechaParaInput(dateString) {
                let [fecha, hora, meridiano] = dateString.split(" ");
                let [year, month, day] = fecha.split("-").map(num => num.padStart(2, "0"));
                let [hour, minute] = hora.split(":").map(num => num.padStart(2, "0"));

                // Convertir a 24 horas si es necesario
                if (meridiano === "PM" && hour !== "12") {
                    hour = String(parseInt(hour) + 12);
                } else if (meridiano === "AM" && hour === "12") {
                    hour = "00"; // Medianoche
                }

                return `${year}-${month}-${day}T${hour}:${minute}`;
            }

            function convertirFechaAStringReserva(fechaInput) {
                let fecha = new Date(fechaInput);
                let year = fecha.getFullYear();
                let month = String(fecha.getMonth() + 1).padStart(2, "0");
                let day = String(fecha.getDate()).padStart(2, "0");
                let hour = fecha.getHours();
                let minute = String(fecha.getMinutes()).padStart(2, "0");
                let meridiano = hour >= 12 ? "PM" : "AM";

                // Convertir a formato 12 horas
                hour = hour % 12 || 12; // 12 AM y 12 PM deben mostrarse correctamente

                return `${year}-${month}-${day} ${String(hour).padStart(2, "0")}:${minute} ${meridiano}`;
            }

            function formatearFechaParaInput(date) {
                let year = date.getFullYear();
                let month = String(date.getMonth() + 1).padStart(2, "0"); // Meses van de 0-11
                let day = String(date.getDate()).padStart(2, "0");
                let hours = String(date.getHours()).padStart(2, "0");
                let minutes = String(date.getMinutes()).padStart(2, "0");

                return `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            // **(1) La fecha de entrada vacía tomará la del resumen o la actual**
            if (reservafechaEntradaResumen) {
                if (!reservafechaEntradaResumen.value) {
                    reservafechaEntradaResumen.value = formatearFechaParaInput(reservafechaActual);
                } else {
                    reservafechaEntradaResumen.value = reservaconvertirFechaParaInput(reservafechaEntradaResumen.value);
                }

                // Inicializar
                reservaactualizarFilas();
            }

            // Formatear fecha a 'YYYY-MM-DD hh:mm A'
            function reservafechaParseString(fecha) {
                const opcionesFecha = { year: 'numeric', month: '2-digit', day: '2-digit' };
                const opcionesHora = { hour: '2-digit', minute: '2-digit', hour12: true };
                const fechaFormateada = fecha.toLocaleDateString('es-ES', opcionesFecha).split('/').reverse().join('-');
                const horaFormateada = fecha.toLocaleTimeString('es-ES', opcionesHora).replace('.', '.');

                return `${fechaFormateada} ${horaFormateada}`;
            }

            function reservafechaParseStringDiaHora(fecha) {
                const opcionesFecha = { day: '2-digit' };
                const opcionesHora = { hour: '2-digit', minute: '2-digit', hour12: true };
                const fechaFormateada = fecha.toLocaleDateString('es-ES', opcionesFecha);
                const horaFormateada = fecha.toLocaleTimeString('es-ES', opcionesHora).replace('.', '.');

                return `| ${fechaFormateada} | ${horaFormateada}`;
            }

            function reservastringParseFecha(fechaStr) {
                let [fecha, hora] = fechaStr.split(" ");
                let [year, month, day] = fecha.split("-").map(num => parseInt(num));
                let [hour, minute] = hora.split(":").map(num => parseInt(num));
                let meridiano = hora.includes("AM") ? "AM" : "PM";

                // Ajustar la hora según AM/PM
                if (meridiano === "PM" && hour < 12) {
                    hour += 12;  // Convertir a 24 horas
                } else if (meridiano === "AM" && hour === 12) {
                    hour = 0; // Convertir medianoche a 00:00
                }

                return new Date(year, month - 1, day, hour, minute);
            }


            // **(4) Calcular fecha de salida**
            function reservacalcularFechaSalida(fecha, tipoServicio) {
                let fechaSalida = new Date(fecha);

                if (tipoServicio.includes("COMPLETO")) {
                    fechaSalida.setDate(fechaSalida.getDate() + 1);
                    fechaSalida.setHours(12, 0, 0); // Medio día del día siguiente
                } else {
                    fechaSalida.setHours(18, 0, 0); // 6 PM del mismo día
                }
                return reservafechaParseString(fechaSalida);
            }

            // **(2) Manejar el cambio de días de alojamiento**
            function reservaactualizarFilas() {
                const dias = parseInt(reservadiasAlojamientoResumen.value) || 1;
                reservatablaFechasBody.innerHTML = ""; // Limpiar la tabla antes de reconstruirla

                let fechaBase = new Date(reservastringParseFecha(convertirFechaAStringReserva(reservafechaEntradaResumen.value)));

                for (let i = 0; i < dias; i++) {
                    let nuevaFila = document.createElement("tr");
                    let fechaEntradaStr = reservafechaParseStringDiaHora(fechaBase);
                    let tipo_servicio = reservaselectServicio.options[reservaselectServicio.selectedIndex];
                    let fechaSalidaStr = reservacalcularFechaSalida(new Date(fechaBase), tipo_servicio.getAttribute("data-tipo"));
                    let fechaSalidaStrDiaHora = reservafechaParseStringDiaHora(reservastringParseFecha(fechaSalidaStr));

                    nuevaFila.innerHTML = `
                            <td class="align-middle text-center">
                                <span class="bg-success-subtle rounded-4 p-2">${fechaEntradaStr}</span>
                            </td>
                            <td class="align-middle text-center">
                                <span class="bg-secondary-subtle rounded-4 p-2">
                                    ${tipo_servicio.getAttribute("data-tipo").includes("COMPLETO") ? "COMPLETO" : "MEDIO DÍA"}
                                </span>
                            </td>
                            <td class="align-middle text-center"><span class="bg-danger-subtle rounded-4 p-2">${fechaSalidaStrDiaHora}</span></td>
                            <td class="align-middle text-center"><span class="mx-3">${'S/. ' + reservacalcularImporte()}</span></td>
                        `;
                    reservatablaFechasBody.appendChild(nuevaFila);

                    fechaBase = new Date(reservastringParseFecha(fechaSalidaStr));
                }

                reservaactualizarResumen();
            }

            // **(3) Calcular importe según tipo de servicio**
            function reservacalcularImporte() {
                let precioBase = parseFloat(reservaprecioInput.getAttribute("data-precio")) || 0;
                let tipo_servicio = reservaselectServicio.options[reservaselectServicio.selectedIndex];

                return tipo_servicio.getAttribute("data-tipo").includes("MEDIO") ? (precioBase / 2).toFixed(2) : precioBase.toFixed(2);
            }

            // **(5) Bloquear servicio si hay más de un día**
            function reservamanejarBloqueoServicio() {
                if (parseInt(reservadiasAlojamientoResumen.value) > 1) {
                    reservaselectServicio.value = "COMPLETO";
                    reservaselectServicio.setAttribute("disabled", true);
                } else {
                    reservaselectServicio.removeAttribute("disabled");
                }
                reservaactualizarFilas();
            }

            // **(6) Calcular monto total**
            function reservacalcularMontoTotal() {
                let dias = parseInt(reservadiasAlojamientoResumen.value) || 1;
                let precioBase = reservacalcularImporte(parseFloat(reservaprecioInput.getAttribute("data-precio")) || 0);
                let descuento = parseFloat(reservadescuentoResumen.value) || 0;
                let adelanto = parseFloat(reservamontoAdelantoResumen.value) || 0;

                return ((dias * precioBase) - descuento - adelanto).toFixed(2);
            }

            // **(4) Calcular fecha de salida**
            function reservacalcularFechaSalidaParaDias(fecha, dias) {
                let fechaSalida = new Date(fecha);

                fechaSalida.setDate(fechaSalida.getDate() + dias);
                fechaSalida.setHours(12, 0, 0); // Medio día del día siguiente

                return fechaParseString(fechaSalida);
            }

            // **Actualizar el resumen final**
            function reservaactualizarResumen() {
                let fechaEntrada = reservastringParseFecha(convertirFechaAStringReserva(reservafechaEntradaResumen.value));
                let dias = parseInt(reservadiasAlojamientoResumen.value) || 1;
                let fechaSalida;

                if (dias > 1) {
                    fechaSalida = reservacalcularFechaSalidaParaDias(fechaEntrada, dias);
                } else {
                    fechaSalida = reservacalcularFechaSalida(fechaEntrada, reservaselectServicio.options[reservaselectServicio.selectedIndex].getAttribute("data-tipo"));
                }

                reservafechaSalidaResumen.value = fechaSalida;
                reservamontoTotalResumen.value = reservacalcularMontoTotal();
            }

            // **Eventos**
            if (reservafechaEntradaResumen) {
                reservafechaEntradaResumen.addEventListener("change", reservaactualizarFilas);
            }
            if (reservadiasAlojamientoResumen) {
                reservadiasAlojamientoResumen.addEventListener("input", reservamanejarBloqueoServicio);
            }
            if (reservaselectServicio) {
                reservaselectServicio.addEventListener("change", reservaactualizarFilas);
            }
            if (reservadescuentoResumen) {
                reservadescuentoResumen.addEventListener("input", reservaactualizarResumen);
            }
            if (reservamontoAdelantoResumen) {
                reservamontoAdelantoResumen.addEventListener("input", reservaactualizarResumen);
            }










            let selects = document.querySelectorAll(".estado-selector");

            if (selects) {
                selects.forEach(select => {
                    let id = select.getAttribute("data-id");
                    let btnGuardar = document.getElementById("guardar_" + id);
                    let estadoInicial = select.value; // Guardamos el estado inicial

                    // Detectar cambios en el estado
                    select.addEventListener("change", function () {
                        if (select.value !== estadoInicial) {
                            btnGuardar.removeAttribute("disabled");
                        } else {
                            btnGuardar.setAttribute("disabled", "true");
                        }
                    });

                    // Evento para guardar cambios al hacer clic en el botón
                    btnGuardar.addEventListener("click", function () {
                        let nuevoEstado = select.value;

                        fetch(`/habitaciones/contenido/actualizar/${id}`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ estado_caracteristica: nuevoEstado })
                        })
                            .then(response => {
                                if (response.ok) {
                                    console.log("Estado actualizado correctamente");
                                    estadoInicial = nuevoEstado; // Actualizar estado inicial
                                    btnGuardar.setAttribute("disabled", "true");
                                } else {
                                    alert("Error al actualizar el estado");
                                }
                            })
                            .catch(error => console.error("Error:", error));
                    });
                });
            }
        });
    </script>

    <script th:src="@{/js/index.js}"></script>
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
</body>

</html>